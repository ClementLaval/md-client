import _e from"fs";import{read as De}from"to-vfile";import{matter as Ce}from"vfile-matter";var V=async r=>{let e=await De(r);Ce(e,{strip:!0});let t=typeof e.value=="string"?e.value:new TextDecoder("utf-8").decode(e.value);return{...Object(e.data.matter),body:t}};var W={name:"Markdown",extension:".md",execute:V};import{read as be}from"to-vfile";var J=async r=>{let e=await be(r);return{...JSON.parse(e.toString())}};var q={name:"JSON",extension:".json",execute:J};var I=async r=>{let e=await import(`/${r}`).then(t=>JSON.stringify(t.default));return{...JSON.parse(e.toString())}};var z={name:"TS",extension:".ts",execute:I},U={name:"Js",extension:".js",execute:I};var u=[W,q,z,U];function g(r){return u.some(e=>r.endsWith(e.extension))}import ve from"pino";import Pe from"pino-pretty";var l=ve({name:"md-client",enabled:!0,level:"warn"},Pe({colorize:!0,ignore:"pid,hostname",translateTime:"SYS:HH:MM:ss",destination:1,sync:!0}));function H(r,e){return e.forEach(async t=>{t.field?.validate&&(t.field.validate({value:t.value})||l.error(`[VALIDATION]: error on ${r}: field name (${t.field.name}) with value (${t.value})`))}),e}function Y(r,e,t){return e.reduce((a,o,p)=>o.toString().startsWith("#")?a:(a[o]===void 0&&(typeof e?.[p+1]=="string"&&(a[o]={}),typeof e?.[p+1]=="number"&&(a[o]=[])),p===e.length-1&&(a[o]=t),a[o]),r)}function G(r){return r.reduce((e,t)=>(Y(e,t.path,t.value),e),{})}async function K(r){return await Promise.all(r.map(async e=>({...e,value:await e.field?.parse(e.value)})))}function Q(r){return r.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/ /g,"-").replace(/[^\w-]+/g,"").toLowerCase().trim()}function X(r,e,t){let a=e.split("/"),o=a[a.length-1],[p,s]=o.split("."),m=Q(p||"undefined-slug"),d=t.name||"undefined-type";return{_slug:m,_type:d,...r}}function Z(r){return typeof r=="object"&&"type"in r&&"children"in r&&"position"in r}function h(r,e=[]){return r==null?[]:Array.isArray(r)?r.flatMap((t,a)=>h(t,[...e,a])):typeof r=="object"?Z(r)?[e]:Object.entries(r).flatMap(([t,a])=>"_type"in r?h(a,[...e,`#${r._type}`,t]):h(a,[...e,t])):[e]}function k(r,e){return e.reduce((t,a)=>a.toString().startsWith("#")?t:t[a],r)}function ee(r,e,t){let a=t.reduce((o,p,s)=>{if(o){if(typeof p=="string"){if(p.toString().startsWith("#"))return o;if("type"in o&&o.type==="array")return o.of.find(m=>m?.name===p);if("type"in o&&o.type==="object")return o.fields.find(m=>m?.name===p);if(Array.isArray(o))return o?.find(m=>m?.name===p)}if(typeof p=="number"){let m=!!(t[s+1]&&t[s+1].toString().startsWith("#"));if(m&&"type"in o&&o.type==="array"){let d=t[s+1].toString().replace("#","");return o?.of.find(D=>D?.name===d)}return!m&&"type"in o&&o.type==="array"?o.of?.at(0):o}}},r.fields);if(!a){l.warn(`"${t.at(-1)}": unknown field on ${e} [${t}]`);return}return Array.isArray(a)?a.length?a[0]:void 0:a}function re(r,e,t){return h(r).map(o=>({path:o,value:k(r,o),field:ee(t,e,o)}))}function C(r){return r.startsWith("/")&&(r=r.slice(1)),r.endsWith("/")&&(r=r.slice(0,-1)),r}async function te(r){let e=b.getInstance(),t=r.split("/"),a=t[t.length-1],[o,p]=a.split("."),s=C(r.replace(a,"")),m=Object.values(e.collections).find(d=>d.path===s);if(m)return await m.find(o);l.error(`No collection found on reference field: ${r}`)}async function oe(r){return Promise.all(r.map(async e=>{if(e.field?.type==="reference"){let t=await te(e.value);return{...e,value:typeof t=="object"?t:e.value}}return e}))}function ie(r,e){return r.map(t=>({...t,value:!t.value&&t.field?.default?t.field.default({document:e}):t.value}))}var y=async(r,e,t)=>{let a=await t.execute(r);a=X(a,r,e);let o=re(a,r,e);return o=await oe(o),o=ie(o,e),o=o,o=o,o=H(r,o),o=o,o=await K(o),G(o)};async function ne(r,e){let t;try{t=_e.readdirSync(e.path)}catch(m){m instanceof Error&&l.error(m.message);return}let o=t.reduce((m,d)=>{let D=d.match(/\.(.+)$/);return m.push({name:d.replace(/\..+$/,""),extension:D?.length?D[0].toString():""}),m},[]).find(m=>m.name===r);if(!o){l.error(`No file found named: ${r}`);return}let p=`${e.path}/${o.name}${o.extension}`;if(!g(o.extension)){l.error(`Invalid extension used: ${o.extension} (${p})`);return}let s=u.find(m=>m.extension===o.extension);if(!s){l.error(`Error: unable to retrieve format for file: ${p} `);return}return l.info(`Processing... ${p}`),y(p,e,s)}import Se from"fs";var ae=r=>r.filter(e=>e!==void 0);async function se(r){let e;try{e=Se.readdirSync(r.path)}catch(s){s instanceof Error&&l.error(s.message),e=[]}let o=e.reduce((s,m)=>{let d=m.match(/\.(.+)$/);return s.push({name:m.replace(/\..+$/,""),extension:d?.length?d[0].toString():""}),s},[]).reduce((s,m)=>(s.push({...m,relativePath:`${r.path}/${m.name}${m.extension}`,format:u.find(d=>d.extension===m.extension)}),s),[]).map(s=>{if(g(s.extension)&&s.format)return l.info(`Processing... ${s.relativePath}`),y(s.relativePath,r,s.format);l.error(`Invalid extension used: ${s.extension} (${s.relativePath})`)});return ae(await Promise.all(o))}var f=class{name;required;validate;default;constructor(e){this.name=e.name,this.required=e.required,this.validate=e.validate,this.default=e.default}};import L from"@vinejs/vine";var v=class extends f{type="array";parse;of;constructor(e){super(e),this.parse=this._parse,this.of=this._of(e)}async _parse(e){let t=L.array(L.any());return await L.validate({schema:t,data:e})}_of(e){return e.type==="array"?e.of.map(t=>c.build(t)):[]}};import me from"@vinejs/vine";var P=class extends f{type="boolean";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=me.boolean();return await me.validate({schema:t,data:e})}};import fe from"@vinejs/vine";var _=class extends f{type="date";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=fe.string();return await fe.validate({schema:t,data:e})}};import pe from"@vinejs/vine";var S=class extends f{type="datetime";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=pe.string();return await pe.validate({schema:t,data:e})}};import le from"@vinejs/vine";var w=class extends f{type="file";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=le.string();return await le.validate({schema:t,data:e})}};import de from"@vinejs/vine";var O=class extends f{type="image";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=de.string();return await de.validate({schema:t,data:e})}};import ue from"@vinejs/vine";var $=class extends f{type="number";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=ue.number();return await ue.validate({schema:t,data:e})}};import N from"@vinejs/vine";import ce from"@vinejs/vine";var F=class extends f{type="string";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=ce.string();return await ce.validate({schema:t,data:e})}};var R=class extends f{type="object";parse;fields;constructor(e){super(e),this.parse=this._parse,this.fields=[new F({name:"_type",type:"string"}),...this._fields(e)]}async _parse(e){let t=N.record(N.any());return await N.validate({schema:t,data:e})}_fields(e){return e.type==="object"?e.fields.map(t=>c.build(t)):[]}};import ge from"@vinejs/vine";var j=class extends f{type="reference";parse;to;constructor(e){super(e),this.parse=this._parse,this.to=this._to(e)}async _parse(e){let t=ge.any();return await ge.validate({schema:t,data:e})}_to(e){return e.type==="reference"?e.to:[]}};import ye from"@vinejs/vine";import{unified as we}from"unified";import Oe from"remark-parse";var A=class extends f{type="richtext";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=we().use(Oe).parse(e),a=ye.any();return await ye.validate({schema:a,data:t})}};import E from"@vinejs/vine";var T=class extends f{type="slug";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=E.string();if(!E.helpers.isSlug(e))throw new Error(`Invalid slug format: ${e}`);return await E.validate({schema:t,data:e})}};var Fe={array:v,boolean:P,date:_,datetime:S,file:w,image:O,number:$,object:R,reference:j,richtext:A,slug:T,string:F};var c=class{static build(e){let t=Fe[e.type];if(!t)throw new Error(`Unknown field type: '${e.type}' (${e.name})`);return new t(e)}};var x=class{name;path;fields;constructor(e){this.name=e.name,this.path=C(e.path),this.fields=this._fields(e.fields)}_fields(e){return[...[{name:"_slug",type:"string",required:!0},{name:"_type",type:"string",required:!0}],...e].map(a=>c.build(a))}};var M=class extends x{constructor(e){super(e)}find(e){return ne(e,this)}findAll(){return se(this)}};import $e from"fs";async function xe(r){let e;try{e=$e.readdirSync(r.path)}catch(s){s instanceof Error&&l.error(s.message);return}let a=e.reduce((s,m)=>{let d=m.match(/\.(.+)$/);return s.push({name:m.replace(/\..+$/,""),extension:d?.length?d[0].toString():""}),s},[]).find(s=>s.name===r.name);if(!a){l.error(`No file found named: ${r.name}`);return}let o=`${r.path}/${a.name}${a.extension}`;if(!g(a.extension)){l.error(`Invalid extension used: ${a.extension} (${o})`);return}let p=u.find(s=>s.extension===a.extension);if(!p){l.error(`Error: unable to retrieve format for file: ${o} `);return}return l.info(`Processing... ${o}`),y(o,r,p)}var B=class extends x{constructor(e){super(e)}find(){return xe(this)}};var he={logger:!1,media:{mediatRoot:"content/uploads",publicFolder:"public"},typescript:{path:"scr/types"},schema:{collections:[],singletons:[]}};var b=class r{collections;singletons;config;constructor(e){this.collections=e.schema.collections.reduce((t,a)=>(t[a.name]=new M(a),t),{}),this.singletons=e.schema.singletons.reduce((t,a)=>(t[a.name]=new B(a),t),{}),this.config=e,r.instance=this}static instance;static getInstance(){return r.instance||(r.instance=new r(he)),r.instance}};export{f as BaseField,b as Client,j as ReferenceField};
