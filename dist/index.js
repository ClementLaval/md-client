import $e from"fs";import{read as Pe}from"to-vfile";import{matter as Oe}from"vfile-matter";function b(t){return t.reduce((e,r)=>(r.type==="array"&&e.push(...r.of.reduce(b,r.of)),r.type==="object"&&e.push(...Object.values(r.fields).reduce(b,r.fields)),r.type==="richtext"&&r.isBody===!0&&e.push(r),e),[])}import ve from"pino";import we from"pino-pretty";var f=ve({enabled:!0,level:"warn"},we({colorize:!0,ignore:"pid,hostname",translateTime:"SYS:HH:MM:ss",destination:1,sync:!0}));var W=async(t,e)=>{let r=await Pe(t);Oe(r,{strip:!0});let i=typeof r.value=="string"?r.value:new TextDecoder("utf-8").decode(r.value),o=b(e.fields),d=o[0]?.name;return o.length||f.warn(`No "body" field setted on document #${e.name}, while processing ${t}. Please use "isBody" on a richtext field.`),o.length>1&&f.warn(`Only on body field can be set: ${e.name}`),{...Object(r.data.matter),...d?{[d]:i}:{}}};var k={name:"Markdown",extension:".md",execute:W};import{read as Se}from"to-vfile";var q=async t=>{let e=await Se(t);return{...JSON.parse(e.toString())}};var J={name:"JSON",extension:".json",execute:q};var L=async t=>{let e=await import(`/${t}`).then(r=>JSON.stringify(r.default));return{...JSON.parse(e.toString())}};var U={name:"TS",extension:".ts",execute:L},z={name:"Js",extension:".js",execute:L};var c=[k,J,U,z];function F(t){return c.some(e=>t.endsWith(e.extension))}function H(t,e){return t.forEach(async r=>{r.field?.validate&&(r.field.validate({value:r.value})||f.error(`[VALIDATION]: error on ${e}: field name (${r.field.name}) with value (${r.value})`))}),t}function G(t,e,r){return e.reduce((i,o,d)=>o.toString().startsWith("#")?i:(i[o]===void 0&&(typeof e?.[d+1]=="string"&&(i[o]={}),typeof e?.[d+1]=="number"&&(i[o]=[])),d===e.length-1&&(i[o]=r),i[o]),t)}function K(t){return t.reduce((e,r)=>(G(e,r.path,r.value),e),{})}function Q(t){return t.forEach(e=>{e.field?.required===!0&&!e.value&&f.error({name:"REQUIRED",msg:`${e.field.name} data is missing but required`})}),t}async function Y(t,e){return await Promise.all(t.map(async r=>({...r,value:await r.field?.parse(r.value,e)})))}function X(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/ /g,"-").replace(/[^\w-]+/g,"").toLowerCase().trim()}function Z(t,e,r){let i=e.split("/"),o=i[i.length-1],[d,m]=o.split("."),s=X(d||"undefined-slug"),u=r.name||"undefined-type";return{_slug:s,_type:u,...t}}function ee(t){return typeof t=="object"&&"type"in t&&"children"in t&&"position"in t}function y(t,e=[]){return t==null?[]:Array.isArray(t)?t.flatMap((r,i)=>y(r,[...e,i])):typeof t=="object"?ee(t)?[e]:Object.entries(t).flatMap(([r,i])=>"_type"in t?y(i,[...e,`#${t._type}`,r]):y(i,[...e,r])):[e]}function te(t,e){return e.reduce((r,i)=>i.toString().startsWith("#")?r:r[i],t)}function re(t,e,r){let i=r.reduce((o,d,m)=>{if(o){if(typeof d=="string"){if(d.toString().startsWith("#"))return o;if("type"in o&&o.type==="array")return o.of.find(s=>s?.name===d);if("type"in o&&o.type==="object")return o.fields.find(s=>s?.name===d);if(Array.isArray(o))return o?.find(s=>s?.name===d)}if(typeof d=="number"){let s=!!(r[m+1]&&r[m+1].toString().startsWith("#"));if(s&&"type"in o&&o.type==="array"){let u=r[m+1].toString().replace("#","");return o?.of.find(D=>D?.name===u)}return!s&&"type"in o&&o.type==="array"?o.of?.at(0):o}}},t.fields);if(!i){f.warn(`"${r.at(-1)}": unknown field on ${e} [${r}]`);return}return Array.isArray(i)?i.length?i[0]:void 0:i}function ie(t,e,r){return y(t).map(o=>({path:o,value:te(t,o),field:re(r,e,o)}))}function v(t){return t.startsWith("/")&&(t=t.slice(1)),t.endsWith("/")&&(t=t.slice(0,-1)),t}async function oe(t){let e=w.getInstance(),r=t.split("/"),i=r[r.length-1],[o,d]=i.split("."),m=v(t.replace(i,"")),s=Object.values(e.collections).find(u=>u.path===m);if(s)return await s.find(o);f.error(`No collection found on reference field: ${t}`)}async function ne(t){return Promise.all(t.map(async e=>{if(e.field?.type==="reference"){let r=await oe(e.value);return{...e,value:typeof r=="object"?r:e.value}}return e}))}function ae(t,e){let r=y(e.fields);return t.map(i=>({...i,value:!i.value&&i.field?.default?i.field.default({document:e}):i.value}))}var x=async(t,e,r)=>{let i=await r.execute(t,e);i=Z(i,t,e);let o=ie(i,t,e);return o=await ne(o),o=ae(o,e),o=o,o=Q(o),o=H(o,t),o=o,o=await Y(o,t),K(o)};async function me(t,e){let r;try{r=$e.readdirSync(e.path)}catch(s){s instanceof Error&&f.error(s.message);return}let o=r.reduce((s,u)=>{let D=u.match(/\.(.+)$/);return s.push({name:u.replace(/\..+$/,""),extension:D?.length?D[0].toString():""}),s},[]).find(s=>s.name===t);if(!o){f.error(`No file found named: ${t}`);return}let d=`${e.path}/${o.name}${o.extension}`;if(!F(o.extension)){f.error(`Invalid extension used: ${o.extension} (${d})`);return}let m=c.find(s=>s.extension===o.extension);if(!m){f.error(`Error: unable to retrieve format for file: ${d} `);return}return f.info(`Processing... ${d}`),x(d,e,m)}import Re from"fs";var se=t=>t.filter(e=>e!==void 0);async function fe(t){let e;try{e=Re.readdirSync(t.path)}catch(m){m instanceof Error&&f.error(m.message),e=[]}let o=e.reduce((m,s)=>{let u=s.match(/\.(.+)$/);return m.push({name:s.replace(/\..+$/,""),extension:u?.length?u[0].toString():""}),m},[]).reduce((m,s)=>(m.push({...s,relativePath:`${t.path}/${s.name}${s.extension}`,format:c.find(u=>u.extension===s.extension)}),m),[]).map(m=>{if(F(m.extension)&&m.format)return f.info(`Processing... ${m.relativePath}`),x(m.relativePath,t,m.format);f.error(`Invalid extension used: ${m.extension} (${m.relativePath})`)});return se(await Promise.all(o))}var p=class{name;required;validate;default;constructor(e){this.name=e.name,this.required=e.required,this.validate=e.validate,this.default=e.default}};import I from"@vinejs/vine";var l=class{constructor(e,r,i,o){this.fieldName=e;this.value=r;this.relativePath=i;this.exceptedType=o;this.execute()}execute(){f.error({name:"PARSING",msg:`Unexpected value for field "${this.fieldName}" in ${this.relativePath}. Received: ${this.value} of type ${typeof this.value}, expected type "${this.exceptedType}".
`})}};var P=class extends p{type="array";of;constructor(e){super(e),this.of=this._of(e)}async parse(e,r){try{let i=I.array(I.any());return await I.validate({schema:i,data:e})}catch{new l(this.name,e,r,"array");return}}_of(e){return e.type==="array"?e.of.map(r=>g.build(r)):[]}};import pe from"@vinejs/vine";var O=class extends p{type="boolean";constructor(e){super(e)}async parse(e,r){try{let i=pe.boolean();return await pe.validate({schema:i,data:e})}catch{new l(this.name,e,r,"boolean");return}}};import le from"@vinejs/vine";var S=class extends p{type="date";constructor(e){super(e)}async parse(e,r){try{let i=le.string();return await le.validate({schema:i,data:e})}catch{new l(this.name,e,r,"date");return}}};import de from"@vinejs/vine";var $=class extends p{type="datetime";constructor(e){super(e)}async parse(e,r){try{let i=de.string();return await de.validate({schema:i,data:e})}catch{new l(this.name,e,r,"datetime");return}}};import ue from"@vinejs/vine";var R=class extends p{type="file";constructor(e){super(e)}async parse(e,r){try{let i=ue.string();return await ue.validate({schema:i,data:e})}catch{new l(this.name,e,r,"file");return}}};import ce from"@vinejs/vine";var _=class extends p{type="image";constructor(e){super(e)}async parse(e,r){try{let i=ce.string();return await ce.validate({schema:i,data:e})}catch{new l(this.name,e,r,"string");return}}};import ge from"@vinejs/vine";var j=class extends p{type="number";constructor(e){super(e)}async parse(e,r){try{let i=ge.number();return await ge.validate({schema:i,data:e})}catch{new l(this.name,e,r,"number");return}}};import V from"@vinejs/vine";import ye from"@vinejs/vine";var h=class extends p{type="string";constructor(e){super(e)}async parse(e,r){try{let i=ye.string();return await ye.validate({schema:i,data:e})}catch{new l(this.name,e,r,"string");return}}};var B=class extends p{type="object";fields;constructor(e){super(e),this.fields=[new h({name:"_type",type:"string"}),...this._fields(e)]}async parse(e,r){try{let i=V.record(V.any());return await V.validate({schema:i,data:e})}catch{new l(this.name,e,r,"object");return}}_fields(e){return e.type==="object"?e.fields.map(r=>g.build(r)):[]}};import Fe from"@vinejs/vine";var E=class extends p{type="reference";to;constructor(e){super(e),this.to=this._to(e)}async parse(e,r){try{let i=Fe.any();return await Fe.validate({schema:i,data:e})}catch{new l(this.name,e,r,"reference");return}}_to(e){return e.type==="reference"?e.to:[]}};import xe from"@vinejs/vine";import{unified as _e}from"unified";import je from"remark-parse";var A=class extends p{type="richtext";isBody=!1;constructor(e){super(e),this.isBody=e.isBody}async parse(e,r){try{let i=_e().use(je).parse(e),o=xe.any();return await xe.validate({schema:o,data:i})}catch{new l(this.name,e,r,"richtext");return}}};import he from"@vinejs/vine";var T=class extends p{type="slug";constructor(e){super(e)}async parse(e,r){try{let i=he.string();return await he.validate({schema:i,data:e})}catch{new l(this.name,e,r,"slug");return}}};var Ce={array:P,boolean:O,date:S,datetime:$,file:R,image:_,number:j,object:B,reference:E,richtext:A,slug:T,string:h};var g=class{static build(e){let r=Ce[e.type];if(!r)throw new Error(`Unknown field type: '${e.type}' (${e.name})`);return new r(e)}};var C=class{name;path;fields;constructor(e){this.name=e.name,this.path=v(e.path),this.fields=this._fields(e.fields)}_fields(e){return[...[{name:"_slug",type:"string",required:!0},{name:"_type",type:"string",required:!0}],...e].map(i=>g.build(i))}};var M=class extends C{constructor(e){super(e)}find(e){return me(e,this)}findAll(){return fe(this)}};import Be from"fs";async function De(t){let e;try{e=Be.readdirSync(t.path)}catch(m){m instanceof Error&&f.error(m.message);return}let i=e.reduce((m,s)=>{let u=s.match(/\.(.+)$/);return m.push({name:s.replace(/\..+$/,""),extension:u?.length?u[0].toString():""}),m},[]).find(m=>m.name===t.name);if(!i){f.error(`No file found named: ${t.name}`);return}let o=`${t.path}/${i.name}${i.extension}`;if(!F(i.extension)){f.error(`Invalid extension used: ${i.extension} (${o})`);return}let d=c.find(m=>m.extension===i.extension);if(!d){f.error(`Error: unable to retrieve format for file: ${o} `);return}return f.info(`Processing... ${o}`),x(o,t,d)}var N=class extends C{constructor(e){super(e)}find(){return De(this)}};var be={logger:!1,media:{mediatRoot:"content/uploads",publicFolder:"public"},typescript:{path:"scr/types"},schema:{collections:[],singletons:[]}};var w=class t{collections;singletons;config;constructor(e){this.collections=e.schema.collections.reduce((r,i)=>(r[i.name]=new M(i),r),{}),this.singletons=e.schema.singletons.reduce((r,i)=>(r[i.name]=new N(i),r),{}),this.config=e,t.instance=this}static instance;static getInstance(){return t.instance||(t.instance=new t(be)),t.instance}};export{p as BaseField,w as Client,E as ReferenceField};
