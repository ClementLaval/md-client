import Se from"fs";import{read as we}from"to-vfile";import{matter as Pe}from"vfile-matter";function b(r){return r.reduce((e,t)=>(t.type==="array"&&e.push(...t.of.reduce(b,t.of)),t.type==="object"&&e.push(...Object.values(t.fields).reduce(b,t.fields)),t.type==="richtext"&&t.isBody===!0&&e.push(t),e),[])}import be from"pino";import ve from"pino-pretty";var f=be({enabled:!0,level:"warn"},ve({colorize:!0,ignore:"pid,hostname",translateTime:"SYS:HH:MM:ss",destination:1,sync:!0}));var W=async(r,e)=>{let t=await we(r);Pe(t,{strip:!0});let o=typeof t.value=="string"?t.value:new TextDecoder("utf-8").decode(t.value),i=b(e.fields),d=i[0]?.name;return i.length||f.warn(`No "body" field setted on document #${e.name}, while processing ${r}. Please use "isBody" on a richtext field.`),i.length>1&&f.warn(`Only on body field can be set: ${e.name}`),{...Object(t.data.matter),...d?{[d]:o}:{}}};var k={name:"Markdown",extension:".md",execute:W};import{read as Oe}from"to-vfile";var J=async r=>{let e=await Oe(r);return{...JSON.parse(e.toString())}};var q={name:"JSON",extension:".json",execute:J};var L=async r=>{let e=await import(`/${r}`).then(t=>JSON.stringify(t.default));return{...JSON.parse(e.toString())}};var z={name:"TS",extension:".ts",execute:L},U={name:"Js",extension:".js",execute:L};var c=[k,q,z,U];function y(r){return c.some(e=>r.endsWith(e.extension))}function H(r,e){return r.forEach(async t=>{t.field?.validate&&(t.field.validate({value:t.value})||f.error(`[VALIDATION]: error on ${e}: field name (${t.field.name}) with value (${t.value})`))}),r}function G(r,e,t){return e.reduce((o,i,d)=>i.toString().startsWith("#")?o:(o[i]===void 0&&(typeof e?.[d+1]=="string"&&(o[i]={}),typeof e?.[d+1]=="number"&&(o[i]=[])),d===e.length-1&&(o[i]=t),o[i]),r)}function K(r){return r.reduce((e,t)=>(G(e,t.path,t.value),e),{})}async function Y(r,e){return await Promise.all(r.map(async t=>({...t,value:await t.field?.parse(t.value,e)})))}function Q(r){return r.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/ /g,"-").replace(/[^\w-]+/g,"").toLowerCase().trim()}function X(r,e,t){let o=e.split("/"),i=o[o.length-1],[d,m]=i.split("."),s=Q(d||"undefined-slug"),u=t.name||"undefined-type";return{_slug:s,_type:u,...r}}function Z(r){return typeof r=="object"&&"type"in r&&"children"in r&&"position"in r}function C(r,e=[]){return r==null?[]:Array.isArray(r)?r.flatMap((t,o)=>C(t,[...e,o])):typeof r=="object"?Z(r)?[e]:Object.entries(r).flatMap(([t,o])=>"_type"in r?C(o,[...e,`#${r._type}`,t]):C(o,[...e,t])):[e]}function ee(r,e){return e.reduce((t,o)=>o.toString().startsWith("#")?t:t[o],r)}function te(r,e,t){let o=t.reduce((i,d,m)=>{if(i){if(typeof d=="string"){if(d.toString().startsWith("#"))return i;if("type"in i&&i.type==="array")return i.of.find(s=>s?.name===d);if("type"in i&&i.type==="object")return i.fields.find(s=>s?.name===d);if(Array.isArray(i))return i?.find(s=>s?.name===d)}if(typeof d=="number"){let s=!!(t[m+1]&&t[m+1].toString().startsWith("#"));if(s&&"type"in i&&i.type==="array"){let u=t[m+1].toString().replace("#","");return i?.of.find(D=>D?.name===u)}return!s&&"type"in i&&i.type==="array"?i.of?.at(0):i}}},r.fields);if(!o){f.warn(`"${t.at(-1)}": unknown field on ${e} [${t}]`);return}return Array.isArray(o)?o.length?o[0]:void 0:o}function re(r,e,t){return C(r).map(i=>({path:i,value:ee(r,i),field:te(t,e,i)}))}function v(r){return r.startsWith("/")&&(r=r.slice(1)),r.endsWith("/")&&(r=r.slice(0,-1)),r}async function oe(r){let e=w.getInstance(),t=r.split("/"),o=t[t.length-1],[i,d]=o.split("."),m=v(r.replace(o,"")),s=Object.values(e.collections).find(u=>u.path===m);if(s)return await s.find(i);f.error(`No collection found on reference field: ${r}`)}async function ie(r){return Promise.all(r.map(async e=>{if(e.field?.type==="reference"){let t=await oe(e.value);return{...e,value:typeof t=="object"?t:e.value}}return e}))}function ne(r,e){return r.map(t=>({...t,value:!t.value&&t.field?.default?t.field.default({document:e}):t.value}))}var x=async(r,e,t)=>{let o=await t.execute(r,e);o=X(o,r,e);let i=re(o,r,e);return i=await ie(i),i=ne(i,e),i=i,i=i,i=H(i,r),i=i,i=await Y(i,r),K(i)};async function ae(r,e){let t;try{t=Se.readdirSync(e.path)}catch(s){s instanceof Error&&f.error(s.message);return}let i=t.reduce((s,u)=>{let D=u.match(/\.(.+)$/);return s.push({name:u.replace(/\..+$/,""),extension:D?.length?D[0].toString():""}),s},[]).find(s=>s.name===r);if(!i){f.error(`No file found named: ${r}`);return}let d=`${e.path}/${i.name}${i.extension}`;if(!y(i.extension)){f.error(`Invalid extension used: ${i.extension} (${d})`);return}let m=c.find(s=>s.extension===i.extension);if(!m){f.error(`Error: unable to retrieve format for file: ${d} `);return}return f.info(`Processing... ${d}`),x(d,e,m)}import $e from"fs";var me=r=>r.filter(e=>e!==void 0);async function se(r){let e;try{e=$e.readdirSync(r.path)}catch(m){m instanceof Error&&f.error(m.message),e=[]}let i=e.reduce((m,s)=>{let u=s.match(/\.(.+)$/);return m.push({name:s.replace(/\..+$/,""),extension:u?.length?u[0].toString():""}),m},[]).reduce((m,s)=>(m.push({...s,relativePath:`${r.path}/${s.name}${s.extension}`,format:c.find(u=>u.extension===s.extension)}),m),[]).map(m=>{if(y(m.extension)&&m.format)return f.info(`Processing... ${m.relativePath}`),x(m.relativePath,r,m.format);f.error(`Invalid extension used: ${m.extension} (${m.relativePath})`)});return me(await Promise.all(i))}var p=class{name;required;validate;default;constructor(e){this.name=e.name,this.required=e.required,this.validate=e.validate,this.default=e.default}};import I from"@vinejs/vine";var l=class{constructor(e,t,o,i){this.fieldName=e;this.value=t;this.relativePath=o;this.exceptedType=i;this.execute()}execute(){f.error({name:"PARSING",msg:`Unexpected value for field "${this.fieldName}" in ${this.relativePath}. Received: ${this.value} of type ${typeof this.value}, expected type "${this.exceptedType}".
`})}};var P=class extends p{type="array";of;constructor(e){super(e),this.of=this._of(e)}async parse(e,t){try{let o=I.array(I.any());return await I.validate({schema:o,data:e})}catch{new l(this.name,e,t,"array");return}}_of(e){return e.type==="array"?e.of.map(t=>g.build(t)):[]}};import fe from"@vinejs/vine";var O=class extends p{type="boolean";constructor(e){super(e)}async parse(e,t){try{let o=fe.boolean();return await fe.validate({schema:o,data:e})}catch{new l(this.name,e,t,"boolean");return}}};import pe from"@vinejs/vine";var S=class extends p{type="date";constructor(e){super(e)}async parse(e,t){try{let o=pe.string();return await pe.validate({schema:o,data:e})}catch{new l(this.name,e,t,"date");return}}};import le from"@vinejs/vine";var $=class extends p{type="datetime";constructor(e){super(e)}async parse(e,t){try{let o=le.string();return await le.validate({schema:o,data:e})}catch{new l(this.name,e,t,"datetime");return}}};import de from"@vinejs/vine";var R=class extends p{type="file";constructor(e){super(e)}async parse(e,t){try{let o=de.string();return await de.validate({schema:o,data:e})}catch{new l(this.name,e,t,"file");return}}};import ue from"@vinejs/vine";var _=class extends p{type="image";constructor(e){super(e)}async parse(e,t){try{let o=ue.string();return await ue.validate({schema:o,data:e})}catch{new l(this.name,e,t,"string");return}}};import ce from"@vinejs/vine";var j=class extends p{type="number";constructor(e){super(e)}async parse(e,t){try{let o=ce.number();return await ce.validate({schema:o,data:e})}catch{new l(this.name,e,t,"number");return}}};import V from"@vinejs/vine";import ge from"@vinejs/vine";var F=class extends p{type="string";constructor(e){super(e)}async parse(e,t){try{let o=ge.string();return await ge.validate({schema:o,data:e})}catch{new l(this.name,e,t,"string");return}}};var B=class extends p{type="object";fields;constructor(e){super(e),this.fields=[new F({name:"_type",type:"string"}),...this._fields(e)]}async parse(e,t){try{let o=V.record(V.any());return await V.validate({schema:o,data:e})}catch{new l(this.name,e,t,"object");return}}_fields(e){return e.type==="object"?e.fields.map(t=>g.build(t)):[]}};import ye from"@vinejs/vine";var A=class extends p{type="reference";to;constructor(e){super(e),this.to=this._to(e)}async parse(e,t){try{let o=ye.any();return await ye.validate({schema:o,data:e})}catch{new l(this.name,e,t,"reference");return}}_to(e){return e.type==="reference"?e.to:[]}};import xe from"@vinejs/vine";import{unified as Re}from"unified";import _e from"remark-parse";var E=class extends p{type="richtext";isBody=!1;constructor(e){super(e),this.isBody=e.isBody}async parse(e,t){try{let o=Re().use(_e).parse(e),i=xe.any();return await xe.validate({schema:i,data:o})}catch{new l(this.name,e,t,"richtext");return}}};import Fe from"@vinejs/vine";var T=class extends p{type="slug";constructor(e){super(e)}async parse(e,t){try{let o=Fe.string();return await Fe.validate({schema:o,data:e})}catch{new l(this.name,e,t,"slug");return}}};var he={array:P,boolean:O,date:S,datetime:$,file:R,image:_,number:j,object:B,reference:A,richtext:E,slug:T,string:F};var g=class{static build(e){let t=he[e.type];if(!t)throw new Error(`Unknown field type: '${e.type}' (${e.name})`);return new t(e)}};var h=class{name;path;fields;constructor(e){this.name=e.name,this.path=v(e.path),this.fields=this._fields(e.fields)}_fields(e){return[...[{name:"_slug",type:"string",required:!0},{name:"_type",type:"string",required:!0}],...e].map(o=>g.build(o))}};var M=class extends h{constructor(e){super(e)}find(e){return ae(e,this)}findAll(){return se(this)}};import je from"fs";async function Ce(r){let e;try{e=je.readdirSync(r.path)}catch(m){m instanceof Error&&f.error(m.message);return}let o=e.reduce((m,s)=>{let u=s.match(/\.(.+)$/);return m.push({name:s.replace(/\..+$/,""),extension:u?.length?u[0].toString():""}),m},[]).find(m=>m.name===r.name);if(!o){f.error(`No file found named: ${r.name}`);return}let i=`${r.path}/${o.name}${o.extension}`;if(!y(o.extension)){f.error(`Invalid extension used: ${o.extension} (${i})`);return}let d=c.find(m=>m.extension===o.extension);if(!d){f.error(`Error: unable to retrieve format for file: ${i} `);return}return f.info(`Processing... ${i}`),x(i,r,d)}var N=class extends h{constructor(e){super(e)}find(){return Ce(this)}};var De={logger:!1,media:{mediatRoot:"content/uploads",publicFolder:"public"},typescript:{path:"scr/types"},schema:{collections:[],singletons:[]}};var w=class r{collections;singletons;config;constructor(e){this.collections=e.schema.collections.reduce((t,o)=>(t[o.name]=new M(o),t),{}),this.singletons=e.schema.singletons.reduce((t,o)=>(t[o.name]=new N(o),t),{}),this.config=e,r.instance=this}static instance;static getInstance(){return r.instance||(r.instance=new r(De)),r.instance}};export{p as BaseField,w as Client,A as ReferenceField};
