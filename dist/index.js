import we from"fs";import{read as ve}from"to-vfile";import{matter as Oe}from"vfile-matter";function D(r){return r.reduce((e,t)=>(t.type==="array"&&e.push(...t.of.reduce(D,t.of)),t.type==="object"&&e.push(...Object.values(t.fields).reduce(D,t.fields)),t.type==="richtext"&&t.isBody===!0&&e.push(t),e),[])}import De from"pino";import be from"pino-pretty";var l=De({name:"md-client",enabled:!0,level:"warn"},be({colorize:!0,ignore:"pid,hostname",translateTime:"SYS:HH:MM:ss",destination:1,sync:!0}));var W=async(r,e)=>{let t=await ve(r);Oe(t,{strip:!0});let a=typeof t.value=="string"?t.value:new TextDecoder("utf-8").decode(t.value),o=D(e.fields),p=o[0]?.name;return o.length||l.warn(`No "body" field setted on document #${e.name}, while processing ${r}. Please use "isBody" on a richtext field.`),o.length>1&&l.warn(`Only on body field can be set: ${e.name}`),{...Object(t.data.matter),...p?{[p]:a}:{}}};var J={name:"Markdown",extension:".md",execute:W};import{read as Pe}from"to-vfile";var k=async r=>{let e=await Pe(r);return{...JSON.parse(e.toString())}};var q={name:"JSON",extension:".json",execute:k};var L=async r=>{let e=await import(`/${r}`).then(t=>JSON.stringify(t.default));return{...JSON.parse(e.toString())}};var z={name:"TS",extension:".ts",execute:L},U={name:"Js",extension:".js",execute:L};var d=[J,q,z,U];function g(r){return d.some(e=>r.endsWith(e.extension))}function H(r,e){return e.forEach(async t=>{t.field?.validate&&(t.field.validate({value:t.value})||l.error(`[VALIDATION]: error on ${r}: field name (${t.field.name}) with value (${t.value})`))}),e}function K(r,e,t){return e.reduce((a,o,p)=>o.toString().startsWith("#")?a:(a[o]===void 0&&(typeof e?.[p+1]=="string"&&(a[o]={}),typeof e?.[p+1]=="number"&&(a[o]=[])),p===e.length-1&&(a[o]=t),a[o]),r)}function Y(r){return r.reduce((e,t)=>(K(e,t.path,t.value),e),{})}async function G(r){return await Promise.all(r.map(async e=>({...e,value:await e.field?.parse(e.value)})))}function Q(r){return r.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/ /g,"-").replace(/[^\w-]+/g,"").toLowerCase().trim()}function X(r,e,t){let a=e.split("/"),o=a[a.length-1],[p,m]=o.split("."),s=Q(p||"undefined-slug"),u=t.name||"undefined-type";return{_slug:s,_type:u,...r}}function Z(r){return typeof r=="object"&&"type"in r&&"children"in r&&"position"in r}function h(r,e=[]){return r==null?[]:Array.isArray(r)?r.flatMap((t,a)=>h(t,[...e,a])):typeof r=="object"?Z(r)?[e]:Object.entries(r).flatMap(([t,a])=>"_type"in r?h(a,[...e,`#${r._type}`,t]):h(a,[...e,t])):[e]}function ee(r,e){return e.reduce((t,a)=>a.toString().startsWith("#")?t:t[a],r)}function te(r,e,t){let a=t.reduce((o,p,m)=>{if(o){if(typeof p=="string"){if(p.toString().startsWith("#"))return o;if("type"in o&&o.type==="array")return o.of.find(s=>s?.name===p);if("type"in o&&o.type==="object")return o.fields.find(s=>s?.name===p);if(Array.isArray(o))return o?.find(s=>s?.name===p)}if(typeof p=="number"){let s=!!(t[m+1]&&t[m+1].toString().startsWith("#"));if(s&&"type"in o&&o.type==="array"){let u=t[m+1].toString().replace("#","");return o?.of.find(C=>C?.name===u)}return!s&&"type"in o&&o.type==="array"?o.of?.at(0):o}}},r.fields);if(!a){l.warn(`"${t.at(-1)}": unknown field on ${e} [${t}]`);return}return Array.isArray(a)?a.length?a[0]:void 0:a}function re(r,e,t){return h(r).map(o=>({path:o,value:ee(r,o),field:te(t,e,o)}))}function b(r){return r.startsWith("/")&&(r=r.slice(1)),r.endsWith("/")&&(r=r.slice(0,-1)),r}async function oe(r){let e=v.getInstance(),t=r.split("/"),a=t[t.length-1],[o,p]=a.split("."),m=b(r.replace(a,"")),s=Object.values(e.collections).find(u=>u.path===m);if(s)return await s.find(o);l.error(`No collection found on reference field: ${r}`)}async function ie(r){return Promise.all(r.map(async e=>{if(e.field?.type==="reference"){let t=await oe(e.value);return{...e,value:typeof t=="object"?t:e.value}}return e}))}function ne(r,e){return r.map(t=>({...t,value:!t.value&&t.field?.default?t.field.default({document:e}):t.value}))}var y=async(r,e,t)=>{let a=await t.execute(r,e);a=X(a,r,e);let o=re(a,r,e);return o=await ie(o),o=ne(o,e),o=o,o=o,o=H(r,o),o=o,o=await G(o),Y(o)};async function ae(r,e){let t;try{t=we.readdirSync(e.path)}catch(s){s instanceof Error&&l.error(s.message);return}let o=t.reduce((s,u)=>{let C=u.match(/\.(.+)$/);return s.push({name:u.replace(/\..+$/,""),extension:C?.length?C[0].toString():""}),s},[]).find(s=>s.name===r);if(!o){l.error(`No file found named: ${r}`);return}let p=`${e.path}/${o.name}${o.extension}`;if(!g(o.extension)){l.error(`Invalid extension used: ${o.extension} (${p})`);return}let m=d.find(s=>s.extension===o.extension);if(!m){l.error(`Error: unable to retrieve format for file: ${p} `);return}return l.info(`Processing... ${p}`),y(p,e,m)}import _e from"fs";var me=r=>r.filter(e=>e!==void 0);async function se(r){let e;try{e=_e.readdirSync(r.path)}catch(m){m instanceof Error&&l.error(m.message),e=[]}let o=e.reduce((m,s)=>{let u=s.match(/\.(.+)$/);return m.push({name:s.replace(/\..+$/,""),extension:u?.length?u[0].toString():""}),m},[]).reduce((m,s)=>(m.push({...s,relativePath:`${r.path}/${s.name}${s.extension}`,format:d.find(u=>u.extension===s.extension)}),m),[]).map(m=>{if(g(m.extension)&&m.format)return l.info(`Processing... ${m.relativePath}`),y(m.relativePath,r,m.format);l.error(`Invalid extension used: ${m.extension} (${m.relativePath})`)});return me(await Promise.all(o))}var f=class{name;required;validate;default;constructor(e){this.name=e.name,this.required=e.required,this.validate=e.validate,this.default=e.default}};import N from"@vinejs/vine";var O=class extends f{type="array";parse;of;constructor(e){super(e),this.parse=this._parse,this.of=this._of(e)}async _parse(e){let t=N.array(N.any());return await N.validate({schema:t,data:e})}_of(e){return e.type==="array"?e.of.map(t=>c.build(t)):[]}};import fe from"@vinejs/vine";var P=class extends f{type="boolean";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=fe.boolean();return await fe.validate({schema:t,data:e})}};import pe from"@vinejs/vine";var w=class extends f{type="date";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=pe.string();return await pe.validate({schema:t,data:e})}};import le from"@vinejs/vine";var _=class extends f{type="datetime";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=le.string();return await le.validate({schema:t,data:e})}};import ue from"@vinejs/vine";var S=class extends f{type="file";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=ue.string();return await ue.validate({schema:t,data:e})}};import de from"@vinejs/vine";var $=class extends f{type="image";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=de.string();return await de.validate({schema:t,data:e})}};import ce from"@vinejs/vine";var R=class extends f{type="number";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=ce.number();return await ce.validate({schema:t,data:e})}};import E from"@vinejs/vine";import ge from"@vinejs/vine";var F=class extends f{type="string";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=ge.string();return await ge.validate({schema:t,data:e})}};var j=class extends f{type="object";parse;fields;constructor(e){super(e),this.parse=this._parse,this.fields=[new F({name:"_type",type:"string"}),...this._fields(e)]}async _parse(e){let t=E.record(E.any());return await E.validate({schema:t,data:e})}_fields(e){return e.type==="object"?e.fields.map(t=>c.build(t)):[]}};import ye from"@vinejs/vine";var B=class extends f{type="reference";parse;to;constructor(e){super(e),this.parse=this._parse,this.to=this._to(e)}async _parse(e){let t=ye.any();return await ye.validate({schema:t,data:e})}_to(e){return e.type==="reference"?e.to:[]}};import Fe from"@vinejs/vine";import{unified as Se}from"unified";import $e from"remark-parse";var A=class extends f{type="richtext";isBody=!1;parse;constructor(e){super(e),this.isBody=e.isBody,this.parse=this._parse}async _parse(e){let t=Se().use($e).parse(e),a=Fe.any();return await Fe.validate({schema:a,data:t})}};import V from"@vinejs/vine";var T=class extends f{type="slug";parse;constructor(e){super(e),this.parse=this._parse}async _parse(e){let t=V.string();if(!V.helpers.isSlug(e))throw new Error(`Invalid slug format: ${e}`);return await V.validate({schema:t,data:e})}};var xe={array:O,boolean:P,date:w,datetime:_,file:S,image:$,number:R,object:j,reference:B,richtext:A,slug:T,string:F};var c=class{static build(e){let t=xe[e.type];if(!t)throw new Error(`Unknown field type: '${e.type}' (${e.name})`);return new t(e)}};var x=class{name;path;fields;constructor(e){this.name=e.name,this.path=b(e.path),this.fields=this._fields(e.fields)}_fields(e){return[...[{name:"_slug",type:"string",required:!0},{name:"_type",type:"string",required:!0}],...e].map(a=>c.build(a))}};var M=class extends x{constructor(e){super(e)}find(e){return ae(e,this)}findAll(){return se(this)}};import Re from"fs";async function he(r){let e;try{e=Re.readdirSync(r.path)}catch(m){m instanceof Error&&l.error(m.message);return}let a=e.reduce((m,s)=>{let u=s.match(/\.(.+)$/);return m.push({name:s.replace(/\..+$/,""),extension:u?.length?u[0].toString():""}),m},[]).find(m=>m.name===r.name);if(!a){l.error(`No file found named: ${r.name}`);return}let o=`${r.path}/${a.name}${a.extension}`;if(!g(a.extension)){l.error(`Invalid extension used: ${a.extension} (${o})`);return}let p=d.find(m=>m.extension===a.extension);if(!p){l.error(`Error: unable to retrieve format for file: ${o} `);return}return l.info(`Processing... ${o}`),y(o,r,p)}var I=class extends x{constructor(e){super(e)}find(){return he(this)}};var Ce={logger:!1,media:{mediatRoot:"content/uploads",publicFolder:"public"},typescript:{path:"scr/types"},schema:{collections:[],singletons:[]}};var v=class r{collections;singletons;config;constructor(e){this.collections=e.schema.collections.reduce((t,a)=>(t[a.name]=new M(a),t),{}),this.singletons=e.schema.singletons.reduce((t,a)=>(t[a.name]=new I(a),t),{}),this.config=e,r.instance=this}static instance;static getInstance(){return r.instance||(r.instance=new r(Ce)),r.instance}};export{f as BaseField,v as Client,B as ReferenceField};
